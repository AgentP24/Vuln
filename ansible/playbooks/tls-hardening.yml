---
# VulnGuard AI - TLS/SSL Hardening Playbook
# pb-tls-hardening
#
# Disables deprecated TLS versions and weak cipher suites
# Supports: Linux (nginx, Apache, OpenSSL)
#
# GUARDRAILS:
# - Creates backup before changes
# - Supports check mode (dry run)
# - Supports rollback via backup restore

- name: TLS/SSL Hardening
  hosts: "{{ target_hosts | default('all') }}"
  become: yes
  gather_facts: yes

  vars:
    # Minimum TLS version (1.2 or 1.3)
    min_tls_version: "TLSv1.2"

    # Strong cipher suites only
    ssl_ciphers: "ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384"

    # Backup directory
    backup_dir: "/var/backups/vulnguard"

    # VulnGuard tracking
    vulnerability_id: "{{ vuln_id | default('UNKNOWN') }}"
    approval_id: "{{ approval_id | default('UNKNOWN') }}"

  pre_tasks:
    - name: Create backup directory
      file:
        path: "{{ backup_dir }}"
        state: directory
        mode: '0750'

    - name: Record pre-change state
      shell: |
        echo "=== VulnGuard Pre-Change State ===" > {{ backup_dir }}/pre_change_{{ ansible_date_time.epoch }}.log
        echo "Vulnerability ID: {{ vulnerability_id }}" >> {{ backup_dir }}/pre_change_{{ ansible_date_time.epoch }}.log
        echo "Approval ID: {{ approval_id }}" >> {{ backup_dir }}/pre_change_{{ ansible_date_time.epoch }}.log
        echo "Timestamp: {{ ansible_date_time.iso8601 }}" >> {{ backup_dir }}/pre_change_{{ ansible_date_time.epoch }}.log
        openssl version >> {{ backup_dir }}/pre_change_{{ ansible_date_time.epoch }}.log 2>&1 || true
      changed_when: false

  tasks:
    # =========================================================================
    # NGINX TLS HARDENING
    # =========================================================================
    - name: Check if nginx is installed
      stat:
        path: /etc/nginx
      register: nginx_installed

    - name: Backup nginx SSL configuration
      copy:
        src: /etc/nginx/nginx.conf
        dest: "{{ backup_dir }}/nginx.conf.{{ ansible_date_time.epoch }}.bak"
        remote_src: yes
      when: nginx_installed.stat.exists

    - name: Create nginx SSL hardening config
      template:
        src: templates/nginx-ssl.conf.j2
        dest: /etc/nginx/conf.d/ssl-hardening.conf
        mode: '0644'
        backup: yes
      when: nginx_installed.stat.exists
      notify: Reload nginx

    - name: Update nginx main config for TLS
      lineinfile:
        path: /etc/nginx/nginx.conf
        regexp: "{{ item.regexp }}"
        line: "{{ item.line }}"
        backup: yes
      loop:
        - regexp: '^\s*ssl_protocols'
          line: "    ssl_protocols TLSv1.2 TLSv1.3;"
        - regexp: '^\s*ssl_ciphers'
          line: "    ssl_ciphers '{{ ssl_ciphers }}';"
        - regexp: '^\s*ssl_prefer_server_ciphers'
          line: "    ssl_prefer_server_ciphers on;"
      when: nginx_installed.stat.exists
      notify: Reload nginx

    # =========================================================================
    # APACHE TLS HARDENING
    # =========================================================================
    - name: Check if Apache is installed
      stat:
        path: /etc/apache2
      register: apache_installed

    - name: Backup Apache SSL configuration
      copy:
        src: /etc/apache2/mods-available/ssl.conf
        dest: "{{ backup_dir }}/apache-ssl.conf.{{ ansible_date_time.epoch }}.bak"
        remote_src: yes
      when: apache_installed.stat.exists
      ignore_errors: yes

    - name: Update Apache SSL protocols
      lineinfile:
        path: /etc/apache2/mods-available/ssl.conf
        regexp: '^\s*SSLProtocol'
        line: "SSLProtocol -all +TLSv1.2 +TLSv1.3"
        backup: yes
      when: apache_installed.stat.exists
      notify: Reload Apache

    - name: Update Apache cipher suites
      lineinfile:
        path: /etc/apache2/mods-available/ssl.conf
        regexp: '^\s*SSLCipherSuite'
        line: "SSLCipherSuite {{ ssl_ciphers }}"
        backup: yes
      when: apache_installed.stat.exists
      notify: Reload Apache

    # =========================================================================
    # SYSTEM-WIDE OPENSSL HARDENING
    # =========================================================================
    - name: Backup OpenSSL configuration
      copy:
        src: /etc/ssl/openssl.cnf
        dest: "{{ backup_dir }}/openssl.cnf.{{ ansible_date_time.epoch }}.bak"
        remote_src: yes

    - name: Ensure MinProtocol is set in OpenSSL
      lineinfile:
        path: /etc/ssl/openssl.cnf
        regexp: '^MinProtocol'
        line: "MinProtocol = TLSv1.2"
        insertafter: '^\[system_default_sect\]'
        backup: yes

    - name: Ensure CipherString is set in OpenSSL
      lineinfile:
        path: /etc/ssl/openssl.cnf
        regexp: '^CipherString'
        line: "CipherString = DEFAULT@SECLEVEL=2"
        insertafter: '^MinProtocol'
        backup: yes

  handlers:
    - name: Reload nginx
      service:
        name: nginx
        state: reloaded
      when: not ansible_check_mode

    - name: Reload Apache
      service:
        name: apache2
        state: reloaded
      when: not ansible_check_mode

  post_tasks:
    - name: Verify TLS configuration
      shell: |
        echo "=== Post-Change Verification ===" > {{ backup_dir }}/post_change_{{ ansible_date_time.epoch }}.log
        # Test nginx if running
        if systemctl is-active --quiet nginx; then
          nginx -t >> {{ backup_dir }}/post_change_{{ ansible_date_time.epoch }}.log 2>&1
        fi
        # Test Apache if running
        if systemctl is-active --quiet apache2; then
          apache2ctl -t >> {{ backup_dir }}/post_change_{{ ansible_date_time.epoch }}.log 2>&1
        fi
        # Check SSL/TLS on localhost if possible
        echo | openssl s_client -connect localhost:443 -tls1_2 2>/dev/null | head -20 >> {{ backup_dir }}/post_change_{{ ansible_date_time.epoch }}.log || true
      changed_when: false
      when: not ansible_check_mode

    - name: Record completion
      debug:
        msg: "TLS hardening completed for vulnerability {{ vulnerability_id }}"
